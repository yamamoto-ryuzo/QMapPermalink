<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>🎯 PyQGIS独立レンダリングテスト - QMapPermalink v1.10.14</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 15px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .hero {
            text-align: center;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        .hero h1 {
            font-size: 36px;
            margin: 0 0 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .hero p {
            font-size: 18px;
            margin: 10px 0;
            opacity: 0.9;
        }
        .feature-highlight {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-panel {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .test-panel h2 {
            margin: 0 0 20px 0;
            font-size: 24px;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .control-group {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }
        .control-group h3 {
            margin: 0 0 15px 0;
            color: #ffd700;
            font-size: 18px;
        }
        .control-group label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: 500;
            color: #fff;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255,255,255,0.2);
        }
        .btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255,215,0,0.3);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,215,0,0.4);
        }
        .btn.danger { 
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%); 
            color: white;
            box-shadow: 0 4px 15px rgba(255,71,87,0.3);
        }
        .btn.success { 
            background: linear-gradient(135deg, #2ed573 0%, #17c0eb 100%); 
            color: white;
            box-shadow: 0 4px 15px rgba(46,213,115,0.3);
        }
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .status-bar {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Consolas', monospace;
            font-size: 14px;
        }
        .status-online { color: #2ed573; font-weight: bold; }
        .status-offline { color: #ff4757; font-weight: bold; }
        .status-testing { color: #ffd700; font-weight: bold; }
        .log-display {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .log-info { color: #17c0eb; }
        .log-success { color: #2ed573; }
        .log-warning { color: #ffd700; }
        .log-error { color: #ff4757; }
        .coordinate-display {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            margin: 8px 0;
            font-size: 13px;
            border-left: 4px solid #ffd700;
        }
        .test-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .test-item {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }
        .test-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .test-item h4 {
            margin: 0 0 15px 0;
            color: #ffd700;
            font-size: 16px;
            text-align: center;
        }
        .test-image {
            width: 100%;
            height: auto;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            transition: border-color 0.3s ease;
        }
        .test-image.loading { border-color: #ffd700; }
        .test-image.success { border-color: #2ed573; }
        .test-image.error { border-color: #ff4757; }
        .image-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }
        .performance-panel {
            background: linear-gradient(135deg, #2ed573 0%, #17c0eb 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            color: white;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .metric-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>🎯 PyQGIS独立レンダリングテスト</h1>
            <p><strong>QMap Permalink v1.10.14</strong> - キャンバス非依存WMS</p>
            <p>PyQGIS QgsMapRendererParallelJobによる完全独立レンダリング</p>
            
            <div class="feature-highlight">
                ✨ 重要: このバージョンはQGISデスクトップの表示位置に関係なく、指定されたBBOXの任意の場所をレンダリングします！
            </div>
        </div>

        <div class="test-grid">
            <div class="test-panel">
                <h2>📍 インタラクティブ地図テスト</h2>
                <div id="map"></div>
                
                <div class="performance-panel">
                    <h3>📊 リアルタイム性能指標</h3>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-value" id="request-count">0</div>
                            <div class="metric-label">総リクエスト</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="success-count">0</div>
                            <div class="metric-label">成功</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="avg-load-time">--</div>
                            <div class="metric-label">平均読込時間(ms)</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="success-rate">100%</div>
                            <div class="metric-label">成功率</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="test-panel">
                <h2>🎛️ 独立レンダリング制御</h2>
                
                <div class="control-group">
                    <h3>🌐 サーバー接続</h3>
                    <div class="status-bar">
                        <span id="server-status" class="status-testing">接続確認中...</span>
                    </div>
                    <div class="btn-grid">
                        <button class="btn" onclick="testConnection()">接続テスト</button>
                        <button class="btn" onclick="getCapabilities()">GetCapabilities</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>📍 位置制御</h3>
                    <label>中心経度:</label>
                    <input type="number" id="center-lon" value="139.6917" step="0.0001">
                    <label>中心緯度:</label>
                    <input type="number" id="center-lat" value="35.6895" step="0.0001">
                    <label>ズームレベル:</label>
                    <input type="number" id="zoom-level" value="12" min="1" max="20">
                    
                    <div class="btn-grid">
                        <button class="btn" onclick="goToLocation(139.6917, 35.6895, 12)">🏢 東京駅</button>
                        <button class="btn" onclick="goToLocation(135.5023, 34.6937, 12)">🏯 大阪城</button>
                        <button class="btn" onclick="goToLocation(139.7673, 35.6814, 15)">🗼 スカイツリー</button>
                        <button class="btn" onclick="goToLocation(135.1955, 34.6901, 13)">⛩️ 神戸</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>🎨 レンダリング設定</h3>
                    <label>座標系:</label>
                    <select id="crs-select" onchange="updateCRS()">
                        <option value="EPSG:3857">EPSG:3857 (Web Mercator)</option>
                        <option value="EPSG:4326">EPSG:4326 (WGS84)</option>
                        <option value="EPSG:2154">EPSG:2154 (RGF93)</option>
                    </select>
                    
                    <label>画像サイズ:</label>
                    <select id="image-size">
                        <option value="256,256">256×256</option>
                        <option value="512,512" selected>512×512</option>
                        <option value="1024,1024">1024×1024</option>
                    </select>
                    
                    <div class="btn-grid">
                        <button class="btn success" onclick="refreshMap()">🔄 地図更新</button>
                        <button class="btn danger" onclick="testIndependentRendering()">🎯 独立テスト</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>📊 現在の状態</h3>
                    <label>中心座標:</label>
                    <div class="coordinate-display" id="current-center">読み込み中...</div>
                    <label>表示範囲 (BBOX):</label>
                    <div class="coordinate-display" id="current-bbox">読み込み中...</div>
                </div>
            </div>
        </div>

        <div class="test-panel">
            <h2>🧪 独立レンダリング画像テスト</h2>
            <p>以下のテストでは、QGISデスクトップの表示位置に関係なく、指定したBBOXの場所の画像が生成されます。</p>
            
            <button class="btn success" onclick="runIndependentTests()" style="width: 100%; margin: 20px 0; padding: 15px; font-size: 18px;">
                🚀 独立レンダリング総合テスト実行
            </button>
            
            <div class="test-gallery">
                <div class="test-item">
                    <h4>🏢 東京駅周辺</h4>
                    <img id="test-img-1" class="test-image" alt="Tokyo Station Area">
                    <div class="image-info" id="info-1">テスト準備中...</div>
                </div>
                <div class="test-item">
                    <h4>🏯 大阪城公園</h4>
                    <img id="test-img-2" class="test-image" alt="Osaka Castle Area">
                    <div class="image-info" id="info-2">テスト準備中...</div>
                </div>
                <div class="test-item">
                    <h4>🗼 東京スカイツリー</h4>
                    <img id="test-img-3" class="test-image" alt="Tokyo Skytree Area">
                    <div class="image-info" id="info-3">テスト準備中...</div>
                </div>
                <div class="test-item">
                    <h4>🌊 横浜みなとみらい</h4>
                    <img id="test-img-4" class="test-image" alt="Yokohama Minatomirai">
                    <div class="image-info" id="info-4">テスト準備中...</div>
                </div>
                <div class="test-item">
                    <h4>⛰️ 富士山周辺</h4>
                    <img id="test-img-5" class="test-image" alt="Mt. Fuji Area">
                    <div class="image-info" id="info-5">テスト準備中...</div>
                </div>
                <div class="test-item">
                    <h4>🏛️ 京都市内</h4>
                    <img id="test-img-6" class="test-image" alt="Kyoto City">
                    <div class="image-info" id="info-6">テスト準備中...</div>
                </div>
            </div>
        </div>

        <div class="test-panel">
            <h2>📋 システムログ</h2>
            <div class="btn-grid" style="margin-bottom: 15px;">
                <button class="btn" onclick="clearLog()">🗑️ ログクリア</button>
                <button class="btn" onclick="toggleAutoLog()">📡 自動ログ切替</button>
            </div>
            <div class="log-display" id="system-log">
                <div class="log-info">[SYSTEM] PyQGIS独立レンダリングテストシステム起動...</div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let wmsLayer;
        let wmsSource;
        let autoLogEnabled = false;
        let requestCount = 0;
        let successCount = 0;
        let totalLoadTime = 0;

        // 独立レンダリングテストシステム初期化
        function initIndependentRenderingTest() {
            logMessage("🎯 Initializing PyQGIS Independent Rendering Test System", "info");
            
            // WMSソースの作成
            wmsSource = new ol.source.ImageWMS({
                url: 'http://localhost:8089/wms',
                params: {
                    'SERVICE': 'WMS',
                    'VERSION': '1.3.0',
                    'REQUEST': 'GetMap',
                    'FORMAT': 'image/png',
                    'TRANSPARENT': true,
                    'LAYERS': 'qgis_map',
                    'CRS': 'EPSG:3857'
                },
                ratio: 1,
                serverType: 'other'
            });

            wmsLayer = new ol.layer.Image({
                source: wmsSource,
                opacity: 0.9
            });

            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM(),
                        opacity: 0.2
                    }),
                    wmsLayer
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([139.6917, 35.6895]),
                    zoom: 12,
                    projection: 'EPSG:3857'
                })
            });

            // イベントリスナー
            map.getView().on('change:center', updateMapInfo);
            map.getView().on('change:resolution', updateMapInfo);
            
            // WMS監視
            wmsSource.on('imageloadstart', function() {
                requestCount++;
                updateMetrics();
                if (autoLogEnabled) logMessage('📡 WMS request started', "info");
            });

            wmsSource.on('imageloadend', function() {
                successCount++;
                updateMetrics();
                if (autoLogEnabled) logMessage('✅ WMS request completed', "success");
            });

            wmsSource.on('imageloaderror', function() {
                updateMetrics();
                logMessage('❌ WMS request failed', "error");
            });

            updateMapInfo();
            checkServerStatus();
            logMessage("🚀 Independent rendering test system ready", "success");
        }

        function updateMetrics() {
            document.getElementById('request-count').textContent = requestCount;
            document.getElementById('success-count').textContent = successCount;
            const successRate = requestCount > 0 ? Math.round((successCount / requestCount) * 100) : 100;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        function updateMapInfo() {
            if (!map) return;

            const view = map.getView();
            const center = view.getCenter();
            const extent = view.calculateExtent();

            const centerLonLat = ol.proj.toLonLat(center);
            document.getElementById('current-center').textContent = 
                `${centerLonLat[0].toFixed(6)}, ${centerLonLat[1].toFixed(6)}`;

            const extentLonLat = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
            document.getElementById('current-bbox').textContent = 
                `${extentLonLat[0].toFixed(6)},${extentLonLat[1].toFixed(6)},${extentLonLat[2].toFixed(6)},${extentLonLat[3].toFixed(6)}`;

            document.getElementById('center-lon').value = centerLonLat[0].toFixed(6);
            document.getElementById('center-lat').value = centerLonLat[1].toFixed(6);
            document.getElementById('zoom-level').value = Math.round(view.getZoom());
        }

        function checkServerStatus() {
            const statusElement = document.getElementById('server-status');
            statusElement.textContent = '接続確認中...';
            statusElement.className = 'status-testing';

            const startTime = Date.now();
            fetch('http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetCapabilities')
                .then(response => {
                    const loadTime = Date.now() - startTime;
                    totalLoadTime += loadTime;
                    document.getElementById('avg-load-time').textContent = Math.round(totalLoadTime / Math.max(requestCount, 1));
                    
                    if (response.ok) {
                        statusElement.textContent = '✅ 独立レンダリングサーバー オンライン';
                        statusElement.className = 'status-online';
                        logMessage('✅ Independent rendering server online', "success");
                    } else {
                        throw new Error(`Server Error: ${response.status}`);
                    }
                })
                .catch(error => {
                    statusElement.textContent = '❌ サーバー オフライン';
                    statusElement.className = 'status-offline';
                    logMessage(`❌ Server connection failed: ${error.message}`, "error");
                });
        }

        function goToLocation(lon, lat, zoom) {
            map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
            map.getView().setZoom(zoom);
            logMessage(`📍 Navigated to: [${lon}, ${lat}] Zoom: ${zoom}`, "info");
        }

        function updateCRS() {
            const newCRS = document.getElementById('crs-select').value;
            wmsSource.updateParams({'CRS': newCRS});
            logMessage(`🌐 CRS updated to: ${newCRS}`, "info");
        }

        function refreshMap() {
            wmsSource.refresh();
            logMessage('🔄 Map refreshed manually', "info");
        }

        function testConnection() {
            logMessage('🧪 Testing connection...', "info");
            checkServerStatus();
        }

        function getCapabilities() {
            logMessage('📄 Fetching GetCapabilities...', "info");
            fetch('http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetCapabilities')
                .then(response => response.text())
                .then(data => {
                    logMessage(`✅ GetCapabilities success (${data.length} bytes)`, "success");
                })
                .catch(error => {
                    logMessage(`❌ GetCapabilities failed: ${error.message}`, "error");
                });
        }

        function testIndependentRendering() {
            logMessage('🎯 Testing independent rendering...', "info");
            const extent = map.getView().calculateExtent();
            const extentWGS84 = ol.proj.transformExtent(extent, 'EPSG:3857', 'EPSG:4326');
            const bbox = `${extentWGS84[0].toFixed(6)},${extentWGS84[1].toFixed(6)},${extentWGS84[2].toFixed(6)},${extentWGS84[3].toFixed(6)}`;
            
            testIndependentImage('test-img-1', 'info-1', {
                bbox: bbox,
                width: 512,
                height: 512,
                crs: 'EPSG:4326'
            }, 'Current View Independent Test');
        }

        function runIndependentTests() {
            logMessage('🚀 Running comprehensive independent rendering tests', "info");
            
            // 各地の独立テスト
            const testCases = [
                { id: 1, bbox: '139.69,35.675,139.71,35.685', name: '🏢 Tokyo Station' },
                { id: 2, bbox: '135.52,34.685,135.54,34.695', name: '🏯 Osaka Castle' },
                { id: 3, bbox: '139.81,35.71,139.83,35.72', name: '🗼 Tokyo Skytree' },
                { id: 4, bbox: '139.61,35.45,139.65,35.47', name: '🌊 Yokohama Minatomirai' },
                { id: 5, bbox: '138.72,35.35,138.74,35.37', name: '⛰️ Mt. Fuji Area' },
                { id: 6, bbox: '135.75,35.0,135.78,35.02', name: '🏛️ Kyoto City' }
            ];

            testCases.forEach((testCase, index) => {
                setTimeout(() => {
                    testIndependentImage(`test-img-${testCase.id}`, `info-${testCase.id}`, {
                        bbox: testCase.bbox,
                        width: 256,
                        height: 256,
                        crs: 'EPSG:4326'
                    }, testCase.name);
                }, index * 1000); // 1秒間隔で実行
            });
        }

        function testIndependentImage(imgId, infoId, params, description) {
            const img = document.getElementById(imgId);
            const info = document.getElementById(infoId);
            
            img.className = 'test-image loading';
            info.textContent = 'PyQGIS独立レンダリング中...';
            
            const startTime = Date.now();
            const url = `http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetMap&FORMAT=image/png&LAYERS=qgis_map&WIDTH=${params.width}&HEIGHT=${params.height}&CRS=${params.crs}&BBOX=${params.bbox}&t=${Date.now()}`;
            
            img.onload = function() {
                const loadTime = Date.now() - startTime;
                img.className = 'test-image success';
                info.innerHTML = `✅ ${description}<br>Size: ${params.width}×${params.height}<br>独立レンダリング成功<br>時間: ${loadTime}ms`;
                logMessage(`✅ Independent rendering success: ${description} (${loadTime}ms)`, "success");
            };
            
            img.onerror = function() {
                const loadTime = Date.now() - startTime;
                img.className = 'test-image error';
                info.innerHTML = `❌ ${description}<br>独立レンダリング失敗<br>時間: ${loadTime}ms`;
                logMessage(`❌ Independent rendering failed: ${description}`, "error");
            };
            
            img.src = url;
        }

        function logMessage(message, type = "info") {
            const logElement = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logClass = `log-${type}`;
            
            const logLine = document.createElement('div');
            logLine.className = logClass;
            logLine.textContent = `[${timestamp}] ${message}`;
            
            logElement.appendChild(logLine);
            logElement.scrollTop = logElement.scrollHeight;
            
            while (logElement.children.length > 100) {
                logElement.removeChild(logElement.firstChild);
            }
        }

        function clearLog() {
            const logElement = document.getElementById('system-log');
            logElement.innerHTML = '<div class="log-info">[SYSTEM] ログクリア</div>';
        }

        function toggleAutoLog() {
            autoLogEnabled = !autoLogEnabled;
            logMessage(autoLogEnabled ? '🔔 自動ログ有効' : '🔇 自動ログ無効', "info");
        }

        // 定期更新
        setInterval(updateMapInfo, 5000);
        setInterval(checkServerStatus, 30000);

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initIndependentRenderingTest();
            logMessage('🎯 PyQGIS Independent Rendering Test System fully loaded', "success");
            
            setTimeout(() => {
                getCapabilities();
            }, 2000);
        });
    </script>
</body>
</html>