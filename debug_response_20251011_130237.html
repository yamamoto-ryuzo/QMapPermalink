<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>QMap Permalink - Interactive Map</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css" type="text/css">
<script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 10px; background: #f8f9fa; }
#map { width: 100%; height: 400px; border: 2px solid #ddd; border-radius: 8px; margin: 10px 0; }
.info-section { margin: 15px 0; padding: 15px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.link-section { margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white; }
.link-title { font-weight: bold; color: #333; margin-bottom: 5px; }
.map-title { font-weight: bold; color: #2c5aa0; margin-bottom: 10px; font-size: 18px; }
a { color: #1a73e8; text-decoration: none; word-break: break-all; }
a:hover { text-decoration: underline; }
.coordinates { font-family: monospace; background: #e9ecef; padding: 5px; border-radius: 3px; }
.error-message { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 5px; border: 1px solid #f8bbd9; }
</style>
</head>
<body>
<h2>🗺️ QMap Permalink - Interactive Map View</h2>
<div class="info-section">
<div class="map-title">📍 QGISマップビュー再現</div>
<p>QGISの現在の地図表示をOpenLayersで再現しています。同じ位置・ズームレベルで表示されます。</p>
</div>


<div class="info-section">
    <div class="map-title">📊 QGISレイヤー情報</div>
    <div class="coordinates">
        <strong>レイヤー数:</strong> 7 | 
        <strong>ベクター:</strong> 有 | 
        <strong>ラスター:</strong> 有
    </div>
    <details style="margin-top: 10px;">
        <summary style="cursor: pointer; font-weight: bold;">📋 表示中のレイヤー一覧</summary>
        <ul style="margin: 10px 0; padding-left: 20px;">
<li><strong>DM_C</strong> (Vector)</li><li><strong>DM_1</strong> (Vector)</li><li><strong>DM_3</strong> (Vector)</li><li><strong>行政区域</strong> (Vector)</li><li><strong>都道府県名</strong> (Vector)</li><li><strong>市区町村名</strong> (Vector)</li><li><strong>Google Maps</strong> (Raster)</li></ul></details></div>

<div class="info-section">
    <div class="map-title">📐 QGISマップ範囲</div>
    <div class="coordinates">
        <strong>範囲:</strong> X: 15553551.47 - 15562340.50, 
        Y: 4255438.78 - 4258935.25<br>
        <strong>回転:</strong> 0.00° | 
        <strong>幅×高:</strong> 8789 × 3496
    </div>
</div>

<div class="info-section">
    <div class="coordinates">
        <strong>ブラウザ表示座標:</strong> 35.683709, 139.759407 | 
        <strong>ズーム:</strong> N/A | 
        <strong>スケール:</strong> 1:21,280 | 
        <strong>座標系:</strong> EPSG:3857
    </div>
</div>

<div id="map"></div>


<script>
// OpenLayersマップの初期化（QGISレイヤー情報を考慮）
const map = new ol.Map({
    target: 'map',
    layers: [
        // OpenStreetMap ベースレイヤー
        new ol.layer.Tile({
            source: new ol.source.OSM(),
            opacity: 0.6
        }),
        // 地理院地図（日本の詳細地図）
        new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
                attributions: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
                maxZoom: 18
            }),
            opacity: 0.8
        })
    ],
    view: new ol.View({
        center: ol.proj.fromLonLat([139.75940667292454, 35.683708808647665]),
        zoom: None
    })
});

// QGISマップ範囲の表示
const qgisExtentInfo = {"xmin": 15553551.467931878, "ymin": 4255438.780619375, "xmax": 15562340.500868123, "ymax": 4258935.250480624, "center_x": 15557945.9844, "center_y": 4257187.01555, "width": 8789.032936245203, "height": 3496.469861248508, "crs": "EPSG:3857", "scale": 21280.199999988385, "rotation": 0.0};
let extentFeatures = [];

// 中心点にマーカーを追加
const marker = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat([139.75940667292454, 35.683708808647665]))
});

const markerStyle = new ol.style.Style({
    image: new ol.style.Circle({
        radius: 10,
        fill: new ol.style.Fill({color: '#ff4444'}),
        stroke: new ol.style.Stroke({color: '#ffffff', width: 3})
    }),
    text: new ol.style.Text({
        text: 'QGIS中心',
        font: '12px Arial',
        fill: new ol.style.Fill({color: '#000'}),
        offsetY: 20,
        backgroundFill: new ol.style.Fill({color: 'rgba(255,255,255,0.8)'})
    })
});

marker.setStyle(markerStyle);
extentFeatures.push(marker);

// QGISの表示範囲があれば範囲枠を表示
if (qgisExtentInfo && qgisExtentInfo.xmin !== undefined) {
    // WGS84座標での範囲を計算（簡易変換）
    const extentGeometry = new ol.geom.Polygon([[
        ol.proj.fromLonLat([qgisExtentInfo.xmin, qgisExtentInfo.ymin]),
        ol.proj.fromLonLat([qgisExtentInfo.xmax, qgisExtentInfo.ymin]),
        ol.proj.fromLonLat([qgisExtentInfo.xmax, qgisExtentInfo.ymax]),
        ol.proj.fromLonLat([qgisExtentInfo.xmin, qgisExtentInfo.ymax]),
        ol.proj.fromLonLat([qgisExtentInfo.xmin, qgisExtentInfo.ymin])
    ]]);
    
    const extentFeature = new ol.Feature({
        geometry: extentGeometry
    });
    
    extentFeature.setStyle(new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#00aa00',
            width: 3,
            lineDash: [10, 5]
        }),
        fill: new ol.style.Fill({
            color: 'rgba(0, 170, 0, 0.1)'
        })
    }));
    
    extentFeatures.push(extentFeature);
}

const overlayLayer = new ol.layer.Vector({
    source: new ol.source.Vector({
        features: extentFeatures
    })
});

map.addLayer(overlayLayer);

// クリックイベントで座標を表示
map.on('click', function(event) {
    const coordinate = ol.proj.toLonLat(event.coordinate);
    alert('クリック位置: ' + coordinate[1].toFixed(6) + ', ' + coordinate[0].toFixed(6));
});

console.log('QMap Permalink OpenLayers Map initialized at: ' + 35.683708808647665 + ', ' + 139.75940667292454);
</script>


<div class="info-section">
<div class="map-title">🔗 外部マップサービス</div>
<p>同じ位置を他のマップサービスでも確認できます：</p>
<div class="link-section">
<div class="link-title">🗺️ Google Maps で表示</div>
<a href="https://www.google.co.jp/maps/@35.683709,139.759407,14.91z" target="_blank" rel="noopener noreferrer">https://www.google.co.jp/maps/@35.683709,139.759407,14.91z</a>
</div>
<div class="link-section">
<div class="link-title">🌍 Google Earth で表示</div>
<a href="https://earth.google.com/web/@35.683709,139.759407,37.30396321a,217885.59542668d,1y,0h,0t,0r" target="_blank" rel="noopener noreferrer">https://earth.google.com/web/@35.683709,139.759407,37.30396321a,217885.59542668d,1y,0h,0t,0r</a>
</div>
</div>
<hr>
<div class="info-section">
<p><strong>📡 QMap Permalink v1.9.18</strong></p>
<p>このインタラクティブマップはQGISプラグイン「QMap Permalink」によって生成されました。</p>
<p>マップをクリックして座標を確認したり、ズーム・パンで周辺を探索できます。</p>
</div>
</body>
</html>