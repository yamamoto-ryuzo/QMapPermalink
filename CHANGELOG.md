# Changelog

All notable changes to the QMap Permalink plugin are documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## Version Format: VA.B.C

- **A**: Major changes due to QGIS core updates or significant plugin architecture changes
- **B**: UI changes, new plugin features, or moderate functionality additions
- **C**: Profile/plugin fixes, minor bug fixes, and small improvements

## [V2.10.0] - 2025-10-21

### Patch: Google Earth 'y' token handlingとスケール推定の改善

### Added
- Google Earth Web の @...a,...d,1y 形式の "y" トークン（ピクセルあたりのメートル: m/px）を解釈し、画面 DPI を用いてより正確にスケールを算出して QGIS の表示に反映する対応を追加しました。

### Changed
- Google Earth 用パーマリンクから distance->scale の逆算ロジックを改善し、'y' トークンがある場合はそちらを優先して scale を算出します。
- パネルのナビゲート入力で Google @ 形式（例: /@lat,lon,1763m/）が貼り付けられた場合にプラグインの内部パーサへルーティングする挙動を安定化しました。
- プラグイン初期化時に発生していた一部の読み込みエラー（未インポートの標準ライブラリ等）を修正しました。

### Fixed
- _parse_google_earth_url のスケール/ズーム推定の不整合を修正。
- 不要なコード断片や静的解析でエラーを出していた箇所をクリーンアップしました。

### Notes
- これらの変更は QGIS 実行環境での画面 DPI や OS スケーリングに依存するため、実運用での厳密な一致が必要な場合は環境依存パラメータの微調整を推奨します。

## [V2.11.0] - 2025-10-22

## [V2.12.0] - 2025-10-22

### Added
- 右上の回転コントロールに小さな回転サイクルボタン（0/90/180/270）を追加。ボタンをクリックするたびに角度を巡回し、WMS に `ANGLE` パラメータを送信して高画質の画像再取得を行えるようにしました。
- OpenLayers テンプレート内のイベントアタッチロジックを簡素化し、DOM 生存性に起因する未登録問題を軽減しました。

### Changed
- 回転ハンドラの実装を安定化させ、静的ボタンの存在時にも確実にクリックイベントが登録されるようにしました。

### Notes
- ブラウザのキャッシュにより古い HTML/JS が読み込まれる場合があります。テンプレートやプラグインを更新した際は強制リロード（Ctrl+Shift+R）やサーバ上のファイル差し替えを行ってください。


### Added
- テーマ対応のWMS出力を追加。`theme` パラメータを指定することで、プロジェクトのマップテーマに基づくレイヤの表示/非表示およびスタイル適用を行い、仮想マップビュー上でPNGを生成します。

### Changed
- 仮想マップビュー方式により、現在のキャンバスやプロジェクト状態を変更せずにテーマのみを適用してレンダリングできるようにしました。
- `exportNamedStyle` に関する QGIS バージョン差を吸収するフォールバックの実装を追加しました。

### Notes
- 本機能は QGIS 3.x 系で動作を想定しています。スタイルのエクスポートや一部の API 挙動は QGIS のマイナーバージョン間で差異があるため、問題が発生した場合は実行環境の QGIS バージョン情報を添えて Issue を報告してください。

## [V2.8.0] - 2025-10-21

### 🔁 外部制御の自動ナビゲートと挙動改善

### Added
- 新機能: パネルの「外部制御 (External Control)」が有効な場合、外部から受信したパーマリンクURLを自動的に適用してナビゲートする機能を追加しました。

### Changed
- 受信した外部URLをパネルのナビゲート欄にセットする際、外部制御がONであれば自動的にナビゲーション処理を呼び出すようにしました。
- パネル起動時に外部制御がONの状態で既に受信済みのURLがある場合、パネル表示と同時に自動ナビゲートを実行します。

### Notes
- 自動ナビゲートはユーザーの表示状態を上書きするため、オン/オフの明示的なトグルと解除UIを用意しています。必要に応じてプレビューや確認ダイアログを追加する運用を検討してください。

## [V2.7.0] - 2025-10-20

### 🔁 回転対応とWMS振る舞いの改善

### Changed
- クライアントから常に ANGLE パラメータを送信するようにし、OpenLayers テンプレートで初期 URL の角度を優先して送出するが、以後は map の現在角度を優先して送信する挙動を導入しました。
- サーバ側で ANGLE=0 の場合は高速パス（直接レンダ）を採用し、ANGLE!=0 の場合は拡張レンダ→画像空間での逆回転→中心クロップ→要求サイズへのリサンプルを行うパイプラインを実装しました。
- BBOX が欠如またはパース失敗の際は暗黙のフォールバックを廃止し、明示的にエラーとして扱うように変更しました。

### Notes
- これらの変更により、サーバが north-up な PNG を返すことで OpenLayers 側で view.rotation を適用した際に座標と画像の整合性が保たれるようになります。ANGLE=0 の高速パスにより通常のリクエストは軽量化されます。

---

## [V2.6.0] - 2025-10-18

### 🧭 座標管理の改善

### Added
- サーバー側で利用可能な場合に PyQGIS から投影定義（proj4/WKT）および軸順情報を収集し、生成する OpenLayers HTML に埋め込む機能を追加しました。クライアントは埋め込まれた情報を利用して座標表示の軸順（X/Y or Lat/Lon）を自動判定します。
- OpenLayers 表示の右下にリアルタイム座標表示（投影座標と緯度経度）およびスケール表示を追加しました。
---

## [V2.0.0] - 2025-10-12 🎉 WMS SUPPORT & EXTERNAL ACCESS

### 🗺️ WMS配信機能の追加と外部アクセス改善

### Added
- **WMS (Web Map Service) 1.3.0 準拠のエンドポイント**: `/wms` により GetCapabilities / GetMap を提供
- **外部アクセス対応**: サーバーが全インターフェース (0.0.0.0) にバインドされ、同一ネットワーク内の別ホストからのアクセスが可能

### Changed
- **OpenLayers HTML の相対パス化**: `/qgis-map` で生成されるページは WMS リクエストをページ起点の相対 URL `/wms` を使用するよう変更し、外部ブラウザからも正常に WMS を参照できるようにしました

### Notes
- セキュリティはデフォルトで簡素化しています。公開環境での運用時はファイアウォールやプロキシで適切にアクセス制御してください。


## V1 系列まとめ (V1.0.0 — V1.10.0)

### 概要
初期の V1 系列 (2025-10-05 〜 2025-10-11) で行った主要な追加・改善のまとめです。V1 系ではプラグインの土台となる機能群を集中的に実装し、ブラウザ連携、HTTP サーバー、テーマ／表示制御、外部連携周りの利便性向上に注力しました。

### ハイライト
- OpenLayers を利用したブラウザ表示（インタラクティブな Web マップ表示）を実装し、QGIS の表示をブラウザ上で再現可能にしました。
- HTTP サーバー機能を専用モジュール `qmap_permalink_server_manager.py` に分離し、起動/停止やリクエスト処理をモジュール化しました。
- Web マップ生成ロジックを `qmap_webmap_generator.py` に分離し、HTML/OpenLayers テンプレート生成を専用化しました。
- Google Maps / Google Earth へのワンクリック連携を追加し、外部地図サービスへ即時に表示を切り替えられる機能を提供しました。
- パーマリンクにテーマ情報（レイヤー状態）を含めるオプションを導入し、地図表示の完全な状態を共有・復元できるようにしました。
- パネル形式 UI へ移行（ダイアログ廃止）、パネル内での多言語対応やインターフェース改善を行いました。
- 回転パラメータ（rotation）のサポート、短いクエリパラメータ形式（x,y,scale,crs,rotation）を導入しました。

### 代表的な変更点（技術的要約）
- モジュール分離による保守性向上: サーバー管理・WebMap 生成・メインロジックを明確に分割。
- テーマ/レイヤー状態のエクスポートと復元: `theme` パラメータを用いた簡潔な共有形式。
- OpenLayers テンプレートの最適化と JavaScript 側の安定化。
- Google 系サービス向け URL 生成アルゴリズムの精度向上（ズーム⇄スケール変換、地球表示パラメータの算出）。

### 利用上の注意
- V1 系は機能拡充に注力したリリース群のため、後続の V2 系では WMS 配信や外部アクセス（ネットワークバインド）の改善などを行い、運用面の強化を行っています。

---
