"""
BBOX Serverè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

BBOX Serverç”¨ã®TOMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆãƒ»ç®¡ç†
"""

from pathlib import Path
from typing import Dict, Any, List, Optional
from qgis.core import QgsMessageLog, Qgis


class BBoxConfig:
    """BBOX Serverè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, config_path: Optional[Path] = None):
        """è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
        
        Args:
            config_path: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆNoneã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆï¼‰
        """
        if config_path is None:
            plugin_dir = Path(__file__).parent.parent
            self.config_path = plugin_dir / "bbox" / "config" / "qmap_bbox.toml"
        else:
            self.config_path = Path(config_path)
        
        self.config_path.parent.mkdir(parents=True, exist_ok=True)
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        self.config = {
            "webserver": {
                "bind": "0.0.0.0",
                "port": 8080,
                "threads": 0
            },
            "cors": {
                "allowed_origins": ["*"]
            },
            "tilesets": [],
            "collections": []
        }
    
    def set_port(self, port: int):
        """ãƒãƒ¼ãƒˆç•ªå·ã‚’è¨­å®š"""
        self.config["webserver"]["port"] = port
    
    def set_bind_address(self, address: str):
        """ãƒã‚¤ãƒ³ãƒ‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š"""
        self.config["webserver"]["bind"] = address
    
    def add_tileset(self, name: str, source: Path, format: str = "png",
                    minzoom: int = 0, maxzoom: int = 18):
        """ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
        
        Args:
            name: ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆå
            source: MBTilesãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
            format: ã‚¿ã‚¤ãƒ«å½¢å¼ï¼ˆpng, jpg, pbfç­‰ï¼‰
            minzoom: æœ€å°ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
            maxzoom: æœ€å¤§ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«
        """
        # ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ç›¸å¯¾ï¼‰
        try:
            relative_source = source.relative_to(self.config_path.parent)
        except ValueError:
            relative_source = source
        
        tileset = {
            "name": name,
            "source": str(relative_source),
            "format": format,
            "minzoom": minzoom,
            "maxzoom": maxzoom
        }
        
        self.config["tilesets"].append(tileset)
        
        QgsMessageLog.logMessage(
            f"ğŸ“¦ Added tileset: {name}",
            "QMapPermalink", Qgis.Info
        )
    
    def add_collection(self, name: str, source: Path, srs: str = "EPSG:4326"):
        """ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        
        Args:
            name: ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å
            source: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ‘ã‚¹ï¼ˆGeoJSON, GeoPackageç­‰ï¼‰
            srs: åº§æ¨™å‚ç…§ç³»
        """
        # ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
        try:
            relative_source = source.relative_to(self.config_path.parent)
        except ValueError:
            relative_source = source
        
        collection = {
            "name": name,
            "source": str(relative_source),
            "srs": srs
        }
        
        self.config["collections"].append(collection)
        
        QgsMessageLog.logMessage(
            f"ğŸ“‹ Added collection: {name}",
            "QMapPermalink", Qgis.Info
        )
    
    def generate_toml(self) -> str:
        """TOMLå½¢å¼ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        
        Returns:
            str: TOMLå½¢å¼ã®è¨­å®šæ–‡å­—åˆ—
        """
        lines = [
            "# BBOX Server Configuration",
            "# Generated by QMapPermalink",
            "",
            "[webserver]",
            f'bind = "{self.config["webserver"]["bind"]}"',
            f'port = {self.config["webserver"]["port"]}',
            f'threads = {self.config["webserver"]["threads"]}',
            "",
            "[webserver.cors]",
            f'allowed_origins = {self._format_string_array(self.config["cors"]["allowed_origins"])}',
            ""
        ]
        
        # ã‚¿ã‚¤ãƒ«ã‚»ãƒƒãƒˆ
        for tileset in self.config["tilesets"]:
            lines.extend([
                "[[tileset]]",
                f'name = "{tileset["name"]}"',
                f'source = "{tileset["source"]}"',
                f'format = "{tileset["format"]}"',
                f'minzoom = {tileset["minzoom"]}',
                f'maxzoom = {tileset["maxzoom"]}',
                ""
            ])
        
        # ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
        for collection in self.config["collections"]:
            lines.extend([
                "[[collection]]",
                f'name = "{collection["name"]}"',
                f'source = "{collection["source"]}"',
                f'srs = "{collection["srs"]}"',
                ""
            ])
        
        return "\n".join(lines)
    
    def _format_string_array(self, array: List[str]) -> str:
        """æ–‡å­—åˆ—é…åˆ—ã‚’TOMLå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"""
        quoted = [f'"{item}"' for item in array]
        return f'[{", ".join(quoted)}]'
    
    def save(self) -> Path:
        """è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
        
        Returns:
            Path: ä¿å­˜ã•ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        """
        toml_content = self.generate_toml()
        
        with open(self.config_path, 'w', encoding='utf-8') as f:
            f.write(toml_content)
        
        QgsMessageLog.logMessage(
            f"ğŸ’¾ Config saved: {self.config_path}",
            "QMapPermalink", Qgis.Info
        )
        
        return self.config_path
    
    def load(self) -> bool:
        """è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        
        Returns:
            bool: èª­ã¿è¾¼ã¿æˆåŠŸæ™‚True
        """
        if not self.config_path.exists():
            QgsMessageLog.logMessage(
                f"âš ï¸ Config file not found: {self.config_path}",
                "QMapPermalink", Qgis.Warning
            )
            return False
        
        # ç°¡æ˜“çš„ãªTOMLãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆåŸºæœ¬çš„ãªå€¤ã®ã¿ã‚µãƒãƒ¼ãƒˆï¼‰
        try:
            with open(self.config_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # TODO: æœ¬æ ¼çš„ãªTOMLãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½¿ã†å ´åˆã¯ toml ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
            QgsMessageLog.logMessage(
                f"âœ… Config loaded: {self.config_path}",
                "QMapPermalink", Qgis.Info
            )
            return True
            
        except Exception as e:
            QgsMessageLog.logMessage(
                f"âŒ Failed to load config: {e}",
                "QMapPermalink", Qgis.Critical
            )
            return False
