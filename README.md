# QMapPermalink

QGISの地図ビューを外部から直接ナビゲートするパーマリンクプラグイン

## 概要

QMapPermalinkは、QGISの地図やプロジェクト内の特定の画面ビュー（位置やズームレベルなど）を固有に指し示す「パーマリンク（固定リンク）」の仕組みを実現するQGISプラグインです。

Webのパーマリンクの概念をGISに応用し、外部資料から地図の特定箇所へワンクリックでジャンプできる画期的な機能を提供します。

## 主な特徴

- **HTTPパーマリンク生成**: QGISの地図画面をHTTPサーバー経由でアクセス可能なURLとして生成（V1.0.3安定版）
- **権限不要の外部連携**: ExcelやPDFなどの資料にHTTPリンクを埋め込み、管理者権限なしでクリック可能
- **瞬時ナビゲーション**: ブラウザ経由でQGIS内の指定位置に瞬時にジャンプし、地図ビューを再現
- **軽量HTTPサーバー**: Python標準モジュールで実装された内蔵サーバー（ポート自動選択）
- **ナビゲーション特化**: 画面移動（パン・ズーム・ジャンプ）とHTTP API連携が主目的

## 使用例

1. **資料作成時**
   - QGISで地図の特定箇所を表示
   - QMapPermalinkでパーマリンクを生成
   - ExcelやPDFの説明資料にリンクを埋め込み

2. **資料閲覧時**
   - 資料内のリンクをクリック
   - QGISが自動的に該当箇所へジャンプ
   - 説明内容と地図画面が瞬時に連携

## コンセプト

QMapPermalinkは、**「QGIS上で地図の特定表示状態を固定的に示し、そのリンク経由で外部から画面を素早く操作・移動できる画期的な仕組み」**を表現しています。

これにより、説明資料とQGISのマップ画面を密接に結びつけ、空間情報の共有・説明の効率化を実現します。

## 利点

- **効率的な情報共有**: 資料と地図画面の密接な連携
- **直感的な操作**: Webのパーマリンクと同じ感覚で使用可能
- **時間短縮**: 手動での画面移動が不要
- **説明の質向上**: 資料と実際の地図表示の完全同期

## 技術仕様

- **プログラミング言語**: Python
- **対応プラットフォーム**: QGIS
- **依存関係**: Python標準モジュール + QGIS API
- **実装方針**: 軽量・高速・シンプル

## インストール

### 開発版インストール

1. このリポジトリをクローンまたはダウンロード
2. QGISプラグインディレクトリに `qmap_permalink` フォルダをコピー
3. QGISを再起動してプラグインを有効化

### 配布版インストール

1. `create_zip.py` を実行して配布用ZIPを作成
2. QGISのプラグインマネージャーから「ZIPファイルからインストール」を選択
3. 作成されたZIPファイルを指定してインストール

## 使い方

### パーマリンクの生成

1. QGISで地図を希望の位置・ズームレベルに調整
2. プラグインを起動（ツールバーのアイコンまたはメニューから）
3. 「Generate Permalink」ボタンをクリック
4. 生成されたパーマリンクURLをコピー

### 外部文書への埋め込み

パーマリンクURLを様々な文書形式に埋め込んで、ワンクリックでQGIS地図ビューにジャンプできます。

#### 📊 Excel での埋め込み方法（HTTPサーバー方式 - 推奨） ✅ 実装済み

1. **HTTPリンク設定**（V1.0.4でスレッド安全対応済み）
   - セルを右クリック → 「リンク」または「ハイパーリンク」を選択
   - アドレス欄にHTTPパーマリンクURL（`http://localhost:8089/qgis-map?location=...`）を貼り付け
   - 表示テキストに「地図を開く」「現地確認」等の説明を入力

2. **実用例**（完全実装済み - 即座に利用可能）
   ```
   | 項目名     | 座標        | 地図リンク（HTTPサーバー）                        |
   |-----------|-------------|------------------------------------------------|
   | 調査地点A  | 35.6762°N   | http://localhost:8089/qgis-map?location=...   |
   | 工事現場B  | 139.6503°E  | http://localhost:8089/qgis-map?x=139&y=35&zoom=15 |
   ```

3. **活用シーン**
   - 現地調査結果の報告書
   - 工事進捗管理表
   - 不動産物件リスト
   - 環境調査データ

#### 📄 PDF での埋め込み方法

1. **リンク作成手順**
   - PDF編集ソフト（Adobe Acrobat等）でリンクツールを選択
   - リンク範囲を指定（テキストや図形）
   - アクションで「Webリンクを開く」を選択
   - URLにパーマリンクを設定

2. **実装パターン**
   - **テキストリンク**: 「→地図で確認」「📍位置を表示」
   - **図形リンク**: 地図上のマーカーや矢印にリンク設定
   - **画像リンク**: 概要図や写真にホットスポット作成

3. **用途例**
   - 技術報告書の位置参照
   - 都市計画図面の詳細確認
   - 観光パンフレットの名所案内

#### 🌐 Web・HTML での活用（HTTPサーバー方式） ✅ 実装済み

1. **HTMLリンク**（最新の実装済み形式）
   ```html
   <a href="http://localhost:8089/qgis-map?location=eyJ4X21pbiI6MTM5LjY...">
     調査地点の詳細位置を地図で確認
   </a>
   ```

2. **Markdown形式**（実際に動作する形式）
   ```markdown
   [工事現場位置](http://localhost:8089/qgis-map?location=eyJ4X21pbiI6MTM5LjY...)
   [パラメータ形式](http://localhost:8089/qgis-map?x=139.123&y=35.456&zoom=15&crs=EPSG:4326)
   ```

#### 💼 PowerPoint での活用

1. **リンク設定**
   - テキストや図形を選択 → 右クリック → 「リンク」
   - 「ファイル、Webページ」でパーマリンクURLを入力

2. **プレゼンテーション活用**
   - 提案資料での現地確認
   - 進捗報告での位置説明
   - 会議中のリアルタイム地図確認

#### 📝 Word での組み込み

1. **ハイパーリンク挿入**
   - テキスト選択 → Ctrl+K または「挿入」→「リンク」
   - アドレスにパーマリンクURLを入力

2. **文書内活用**
   - 調査報告書の位置参照
   - 提案書の対象地確認
   - マニュアルでの操作説明

#### ⚙️ 技術的な注意点（最新版）

- **HTTPサーバー**: `http://localhost:8089/` でローカルHTTPサーバーが動作（V1.0.3）
- **自動起動**: プラグイン読み込み時にHTTPサーバーが自動起動
- **ポート自動選択**: 8089〜8099の範囲で使用可能なポートを自動検出
- **QGIS起動要件**: リンククリック時にQGISとプラグインが起動している必要があります
- **権限不要**: ローカルホストのみなので管理者権限や特別な設定は不要
- **ブラウザ経由**: 標準的なWebブラウザを使用してQGISに接続
- **バックアップ**: パーマリンクと併せて座標値も記載することを推奨

#### 🖥️ HTTPサーバー方式の動作環境 ✅ **実装済み**

**現在の実装**: V1.0.3ではHTTPサーバー方式を採用しているため、レジストリ設定は不要です。

##### ✅ 自動動作（現在の実装）
- プラグイン読み込み時にHTTPサーバーが自動起動
- ポート8089〜8099で自動的に使用可能なポートを検出
- 管理者権限不要、レジストリ変更不要
- 標準的なWebブラウザ経由でQGISに接続

##### 🔧 旧方式（カスタムプロトコル）について
以前のバージョンで検討されていた `qgis-permalink://` カスタムプロトコル方式は、企業環境での権限制約のため、より実用的なHTTPサーバー方式に変更されました。

##### 🔧 権限不要の実用的な代替方式（推奨）

レジストリ変更が困難な環境での実用的なソリューション：

##### 1. **QGISショートカットファイル方式** ⭐️ 最推奨
```
QMapPermalink_調査地点A.lnk
```
- **作成方法**: プラグインがQGISショートカットを自動生成
- **パラメータ渡し**: コマンドライン引数でパーマリンク情報を渡す
- **実行**: ショートカットをダブルクリックするとQGISが起動し、自動で地図移動
- **利点**: 管理者権限不要、分かりやすいファイル名、Explorerで管理可能

##### 2. **専用ファイル形式（.qpl）方式**
```
調査地点A_座標情報.qpl
```
- **ファイル内容**: JSON形式でパーマリンク情報を保存
- **実行方法**: 
  1. .qplファイルをダブルクリック
  2. "プログラムから開く"でQGISを選択（初回のみ）
  3. QGISプラグインが自動でファイルを読み込み、地図移動
- **Excel埋め込み**: ファイルをセルにリンクとして埋め込み

##### 3. **バッチファイル＋JSON方式**
```
地図移動_工事現場B.bat
```
- **バッチ内容**:
  ```batch
  @echo off
  "C:\Program Files\QGIS 3.34\bin\qgis.exe" --qpl-file "%~dp0地図移動_工事現場B.json"
  ```
- **JSONファイル**: 座標・ズーム情報を別ファイルで管理
- **利点**: 実行が確実、デバッグしやすい

##### 4. **クリップボード連携方式**
```
Ctrl+C でパーマリンクをコピー → QGISで Ctrl+Shift+V で地図移動
```
- **手順**:
  1. 文書でパーマリンクテキストを選択してコピー
  2. QGISを開く
  3. プラグインのホットキー（Ctrl+Shift+V）で即座に移動
- **利点**: 最もシンプル、権限不要、どんな文書でも対応

##### 5. **QRコード方式**（モバイル・タブレット連携）
```
📱 QRコードをスキャン → タブレットでQGIS Web Client表示
```
- **活用場面**: 現地調査、野外作業
- **メリット**: モバイル端末との連携、オフライン対応可能

##### 6. **ローカルHTTPサーバー方式** 🚀 ✅ **実装済み（V1.0.2）**
```
http://localhost:8089/qgis-map?location=eyJ4X21pbiI6MTM5LjY...
```
- **実装状況**: ✅ **完全実装済み**
- **自動起動**: プラグイン読み込み時にHTTPサーバーが自動起動
- **ポート自動選択**: 8089〜8099の範囲で使用可能なポート自動検出
- **マルチスレッド**: 複数リクエストの並行処理対応
- **利点**: 
  - ✅ 権限不要（ローカルホストのみ）
  - ✅ 既存のWebブラウザを活用
  - ✅ REST API形式で拡張しやすい
  - ✅ デバッグが容易

**実装済みエンドポイント（V1.0.4）**:
```
http://localhost:8089/qgis-map?location=<encoded_data>                    # JSON形式（推奨）
http://localhost:8089/qgis-map?x=139.123&y=35.456&zoom=15&crs=EPSG:4326 # パラメータ形式
http://localhost:8089/navigate?permalink=<encoded_data>                  # ナビゲーション用
http://localhost:8089/status                                             # サーバー状態確認
```

**Excel/PDF埋め込み例**（V1.0.4でスレッド安全性確保済み）:
```
| 地点名    | 地図リンク                                                      |
|----------|------------------------------------------------------------|
| 現場A    | http://localhost:8089/qgis-map?location=eyJ4X21pbiI6MTM5... |
| 現場B    | http://localhost:8089/qgis-map?x=139&y=35&zoom=15          |
```

**サーバー状態の確認**:
- ブラウザで `http://localhost:8089/status` にアクセス
- JSONレスポンスでサーバーの動作状況を確認可能

##### 7. **WebSocket方式**（リアルタイム連携）
```
ws://localhost:8090/qgis-permalink-ws
```
- **特徴**: 双方向通信でリアルタイム連携
- **活用**: 複数の外部アプリケーションとの同期
- **用途**: プレゼンテーション中の地図操作同期

##### 8. **Email連携方式**
```
件名: [QGIS地図] 調査地点A
本文: 以下のリンクをクリック後、QGISプラグインで「メールから取得」ボタンを押してください
mailto:qgis-permalink@local?subject=調査地点A&body=座標データ...
```

##### 🏢 企業環境での実装推奨パターン

**パターン1: ショートカットファイル方式**（最も実用的）
```
共有フォルダ/地図リンク/
├── 📁 工事プロジェクトA/
│   ├── 🔗 現場入口.lnk
│   ├── 🔗 作業エリア1.lnk
│   └── 🔗 作業エリア2.lnk
└── 📁 調査プロジェクトB/
    ├── 🔗 観測点1.lnk
    └── 🔗 観測点2.lnk
```

**パターン2: Excel + HTTPサーバー方式** ✅ **実装済み（最推奨）**
```
| 地点名    | 座標      | 地図リンク                                               | 
|----------|-----------|-------------------------------------------------------|
| 現場A    | 35.xxx°N  | http://localhost:8089/qgis-map?location=eyJ4X21pbiI... |
| 現場B    | 139.xxx°E | http://localhost:8089/qgis-map?x=139&y=35&zoom=15      |
```
**特徴**: V1.0.4でスレッド安全対応済み、権限不要、ブラウザ経由で確実動作、Windows fatal exception対策完了

**パターン3: Excel + .qplファイル方式**
```
| 地点名    | 座標      | 地図ファイル        | 
|----------|-----------|-------------------|
| 現場A    | 35.xxx°N  | [📁現場A.qpl]      |
| 現場B    | 139.xxx°E | [📁現場B.qpl]      |
```

**導入の利点**:
- ✅ 管理者権限不要
- ✅ IT部門の承認不要  
- ✅ 既存のファイル管理システムを活用
- ✅ セキュリティリスクなし（ローカルホストのみ）
- ✅ 段階的導入が可能
- ✅ HTTPサーバー方式なら標準的なWeb技術を活用
- ✅ REST API形式で他システムとの連携も容易

**運用上の考慮事項**:
- 共有フォルダでのファイル管理ルール策定
- ファイル命名規則の統一
- バックアップとバージョン管理
- チーム内での使用方法研修

#### 🎯 効果的な使い方

1. **説明文の工夫**
   - ❌ 悪い例: `qgis-permalink://eyJ4X21pbiI6MTM5LjY...`
   - ✅ 良い例: `📍 工事現場の詳細位置（地図で確認）`

2. **複数地点の管理**
   - インデックス番号や色分けで識別しやすく
   - 地点名や目的を併記して分かりやすく

3. **チーム共有**
   - 共通のQGISプロジェクトファイルを使用
   - パーマリンク生成のルールを統一

### パーマリンクからのナビゲーション

1. パーマリンクURLをコピー
2. プラグインダイアログの下部テキストボックスに貼り付け
3. 「Navigate」ボタンをクリックして地図ビューに移動

## 開発情報

### ファイル構成

```
qmap_permalink/
├── __init__.py                      # プラグイン初期化
├── qmap_permalink.py               # メインプラグインロジック
├── qmap_permalink_dialog.py        # ダイアログクラス
├── qmap_permalink_dialog_base.ui   # Qt Designer UIファイル
├── metadata.txt                    # プラグインメタデータ
├── icon.png                       # プラグインアイコン
└── i18n/                          # 多言語対応
    ├── QMapPermalink_ja.ts        # 日本語翻訳
    ├── QMapPermalink_fr.ts        # フランス語翻訳
    └── [その他の言語ファイル]
```

### 翻訳ファイルのコンパイル

```bash
python compile_translations.py
```

### 配布用ZIPの作成

```bash
python create_zip.py
```

### 対応言語

- 英語 (English) - デフォルト
- 日本語 (Japanese)
- フランス語 (French)
- ドイツ語 (German)
- スペイン語 (Spanish)
- イタリア語 (Italian)
- ポルトガル語 (Portuguese)
- 中国語 (Chinese)
- ロシア語 (Russian)
- ヒンディー語 (Hindi)

### 技術仕様

- **QGIS互換性**: 3.44 - 3.999
- **Qt要件**: Qt5
- **プログラミング言語**: Python 3
- **UIフレームワーク**: Qt Designer (.ui ファイル)
- **翻訳システム**: Qt Linguist (.ts/.qm ファイル)
- **HTTPサーバー**: 内蔵軽量サーバー（ポート8089-8099自動選択）
- **現在バージョン**: V1.0.4（QGIS API スレッド安全対応、Qt シグナル・スロット採用）

## ライセンス

このプロジェクトは[ライセンス](LICENSE)の下で公開されています。

## 貢献

プロジェクトへの貢献を歓迎します。Issue報告やプルリクエストをお待ちしています。

---

**QMapPermalink** - GIS特有の「地図ビューリンク」に特化した新しい価値を創出し、資料と地図画面連携の新しい利便性を実現します。