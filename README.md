# QMapPermalink

QGISの地図ビューを外部から直接ナビゲートするパーマリンクプラグイン

## 概要

QMapPermalinkは、QGISの地図やプロジェクト内の特定の画面ビュー（位置やズームレベルなど）を固有に指し示す「パーマリンク（固定リンク）」の仕組みを実現するQGISプラグインです。

Webのパーマリンクの概念をGISに応用し、外部資料から地図の特定箇所へワンクリックでジャンプできる画期的な機能を提供します。

## 主な特徴

- **HTTPパーマリンク生成**: QGISの地図画面をHTTPサーバー経由でアクセス可能なURLとして生成（V1.1.0 現行）
- **Google Maps連携**: 同一地点のGoogle Mapsハイパーリンクを自動生成し、共有・ブラウザ確認が容易（V1.1.0）
- **権限不要の外部連携**: ExcelやPDFなどの資料にHTTPリンクを埋め込み、管理者権限なしでクリック可能
- **瞬時ナビゲーション**: ブラウザ経由でQGIS内の指定位置に瞬時にジャンプし、地図ビューを再現
- **軽量HTTPサーバー**: Python標準モジュールで実装された内蔵サーバー（ポート自動選択）
- **ナビゲーション特化**: 画面移動（パン・ズーム・ジャンプ）とHTTP API連携が主目的
- **パネルUI**: ドッキング可能なパネル形式で効率的なワークフロー

## UI形式

QMapPermalinkはパネル（Panel）形式のUIを提供します：

### パネル（Panel）形式
- QGISの作業エリアにドッキング可能なパネル
- 常時アクセス可能で、ワークフローの効率化が可能
- 左右のドックエリアに配置可能
- QGISの他のパネルと同様に管理

## 使用例

1. **資料作成時**
   - QGISで地図の特定箇所を表示
   - QMapPermalinkでパーマリンクを生成
   - ExcelやPDFの説明資料にリンクを埋め込み

2. **資料閲覧時**
   - 資料内のリンクをクリック
   - QGISが自動的に該当箇所へジャンプ
   - 説明内容と地図画面が瞬時に連携

3. **パネル形式での効率的なワークフロー**
   - パネルを常時表示して作業
   - 複数のパーマリンクを素早く生成・管理
   - ブラウザでの確認もワンクリック

## コンセプト

QMapPermalinkは、**「QGIS上で地図の特定表示状態を固定的に示し、そのリンク経由で外部から画面を素早く操作・移動できる画期的な仕組み」**を表現しています。

これにより、説明資料とQGISのマップ画面を密接に結びつけ、空間情報の共有・説明の効率化を実現します。

#### 🚀 現行バージョンで提供している機能

- QGIS起動時にローカルHTTPサーバーが自動起動し、`/qgis-map` エンドポイントへのアクセスで地図を移動できます。
- `ll`・`lat/lon`・`x/y` などの座標パラメータを使った簡易ジャンプもサポートしています（`crs` と `scale`/`rotation` を併用可能）。
- 応答ページには同じ地点を開くためのGoogle Mapsリンクが含まれます。

### 既定のパーマリンク形式（シンプルURL）

デフォルトで生成されるパーマリンクは短い `x/y/scale` 形式です（外部資料での共有に最適）。rotation も含めて送信できます。

例（WGS84）:

```
http://localhost:8089/qgis-map?x=139.01234&y=35.12345&scale=1000.0&rotation=0.00
```

例（投影座標、CRS 指定）:

```
http://localhost:8089/qgis-map?x=15617768.94&y=4345862.78&scale=1440000.0&crs=EPSG:3857&rotation=12.34
```

従来の `location`（エンコード済みJSON）は互換のため引き続き受け付けますが、共有や手入力が多い環境では上記シンプルURLを推奨します。

### シンプルURL例

短い形式での利用例（推奨）:

```
http://localhost:8089/qgis-map?x=139&y=35&scale=1000.0
```

この形式は `x`（経度）と `y`（緯度）を直接指定するため、URLが非常に短くなり、Excelやドキュメントで取り扱いやすくなります。デフォルトの `crs` は `EPSG:4326` として解釈されます。

注意: プラグインは `scale` を標準パラメータとして扱います。`zoom` は QGIS のスケールを正確に表現できない場合があるため、基本的には `scale` を使ってください。`zoom` は主に Google Maps へ渡すための推定値としてオプションで利用されます。



**Excel / PDF / Web文書での活用例**

| 地点名 | 地図リンク |
|--------|-------------|
| 現場A  | http://localhost:8089/qgis-map?location=eyJ4X21pbiI6MTM5... |
| 現場B  | http://localhost:8089/qgis-map?x=139&y=35&scale=1000.0 |

生成したURLをそのまま貼り付ければ、ブラウザ経由でQGISが該当ビューへ移動します。社内資料やメール、チャットでも共有可能です。

### パーマリンクからのナビゲーション

1. パーマリンクURLをコピー
2. プラグインダイアログの下部テキストボックスに貼り付け
3. 「Navigate」ボタンをクリックして地図ビューに移動

## 開発情報

### ファイル構成

```
qmap_permalink/
├── __init__.py                      # プラグイン初期化
├── qmap_permalink.py               # メインプラグインロジック
├── qmap_permalink_dialog.py        # ダイアログクラス
├── qmap_permalink_dialog_base.ui   # Qt Designer UIファイル
├── metadata.txt                    # プラグインメタデータ
├── icon.png                       # プラグインアイコン
└── i18n/                          # 多言語対応ファイル
   ├── QMapPermalink_de.ts / .qm   # ドイツ語
   ├── QMapPermalink_fr.ts / .qm   # フランス語
   └── QMapPermalink_ja.ts / .qm   # 日本語
```

### 翻訳ファイルのコンパイル

```bash
python compile_translations.py
```

### 配布用ZIPの作成

```bash
python create_zip.py
```

### 対応言語

- 英語 (English) - デフォルト
- 日本語 (Japanese)
- フランス語 (French)
- ドイツ語 (German)

### 技術仕様

- **QGIS互換性**: 3.00 - 3.99
- **Qt要件**: Qt5
- **プログラミング言語**: Python 3
- **UIフレームワーク**: Qt Designer (.ui ファイル)
- **翻訳システム**: Qt Linguist (.ts/.qm ファイル)
- **HTTPサーバー**: 内蔵軽量サーバー（ポート8089-8099自動選択）
- **現在バージョン**: V1.1.0（Google Maps連携とHTTPレスポンス強化、QGIS APIスレッド安全対応）

## ライセンス

このプロジェクトは[ライセンス](LICENSE)の下で公開されています。

## 貢献

プロジェクトへの貢献を歓迎します。Issue報告やプルリクエストをお待ちしています。

---

**QMapPermalink** - GIS特有の「地図ビューリンク」に特化した新しい価値を創出し、資料と地図画面連携の新しい利便性を実現します。
