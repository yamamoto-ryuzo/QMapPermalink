<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>åœ°å›³è¡¨ç¤ºãƒ‡ãƒãƒƒã‚° - è©³ç´°è¨ºæ–­</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f5f5f5; }
        .debug-panel { background: white; border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .debug-title { font-weight: bold; color: #333; margin-bottom: 10px; font-size: 16px; }
        #map { width: 100%; height: 400px; border: 3px solid #ff0000; background: #f0f0f0; }
        .log { font-family: monospace; font-size: 12px; background: #000; color: #0f0; padding: 10px; max-height: 200px; overflow-y: auto; }
        .error { color: #ff0000; font-weight: bold; }
        .success { color: #00aa00; font-weight: bold; }
        .info { color: #0066cc; }
        .test-step { margin: 5px 0; padding: 5px; background: #f9f9f9; border-left: 4px solid #ccc; }
        .step-success { border-left-color: #4caf50; }
        .step-error { border-left-color: #f44336; }
        .coordinates { font-family: monospace; background: #ffffcc; padding: 5px; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="debug-panel">
        <div class="debug-title">ğŸ” åœ°å›³è¡¨ç¤ºå•é¡Œ - è©³ç´°è¨ºæ–­ãƒ„ãƒ¼ãƒ«</div>
        <p>ã“ã®ç”»é¢ã§åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œãªã„åŸå› ã‚’ç‰¹å®šã—ã¾ã™ã€‚å„ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
        <div id="overall-status" class="test-step">è¨ºæ–­å®Ÿè¡Œä¸­...</div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">ğŸ“‹ è¨ºæ–­ã‚¹ãƒ†ãƒƒãƒ—</div>
        <div id="step1" class="test-step">ã‚¹ãƒ†ãƒƒãƒ—1: OpenLayersãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèª</div>
        <div id="step2" class="test-step">ã‚¹ãƒ†ãƒƒãƒ—2: åŸºæœ¬ãƒãƒƒãƒ—åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</div>
        <div id="step3" class="test-step">ã‚¹ãƒ†ãƒƒãƒ—3: åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ</div>
        <div id="step4" class="test-step">ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ†ã‚¹ãƒˆ</div>
        <div id="step5" class="test-step">ã‚¹ãƒ†ãƒƒãƒ—5: å®Ÿéš›ã®åœ°å›³è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">ğŸ—ºï¸ åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢</div>
        <p>ã“ã“ã«åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚èµ¤ã„æ ãŒè¦‹ãˆã‚‹å ´åˆã¯ã€åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã¯å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚</p>
        <div id="map"></div>
    </div>

    <div class="debug-panel">
        <div class="debug-title">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</div>
        <div id="debug-log" class="log">è¨ºæ–­é–‹å§‹...
</div>
    </div>

    <script>
        let debugLog = document.getElementById('debug-log');
        let stepCount = 0;
        let errorCount = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            debugLog.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>
`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function updateStep(stepId, message, success = true) {
            const step = document.getElementById(stepId);
            step.innerHTML = message;
            step.className = success ? 'test-step step-success' : 'test-step step-error';
            if (!success) errorCount++;
        }

        function runDiagnostics() {
            log('ğŸš€ åœ°å›³è¡¨ç¤ºè¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™', 'info');

            // ã‚¹ãƒ†ãƒƒãƒ—1: OpenLayersãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª
            try {
                if (typeof ol === 'undefined') {
                    throw new Error('OpenLayersãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                log(`âœ… OpenLayersãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œå‡º: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${ol.VERSION_}`, 'success');
                updateStep('step1', `âœ… ã‚¹ãƒ†ãƒƒãƒ—1: OpenLayers v${ol.VERSION_} èª­ã¿è¾¼ã¿æˆåŠŸ`, true);
            } catch (error) {
                log(`âŒ ã‚¹ãƒ†ãƒƒãƒ—1 å¤±æ•—: ${error.message}`, 'error');
                updateStep('step1', `âŒ ã‚¹ãƒ†ãƒƒãƒ—1: ${error.message}`, false);
                return;
            }

            // ã‚¹ãƒ†ãƒƒãƒ—2: åŸºæœ¬ãƒãƒƒãƒ—åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
            try {
                log('ğŸ“ åŸºæœ¬ãƒãƒƒãƒ—åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                const testCoords = [139.6917, 35.6895]; // æ±äº¬
                log(`ä½¿ç”¨åº§æ¨™: çµŒåº¦=${testCoords[0]}, ç·¯åº¦=${testCoords[1]}`, 'info');

                const map = new ol.Map({
                    target: 'map',
                    layers: [],
                    view: new ol.View({
                        center: ol.proj.fromLonLat(testCoords),
                        zoom: 10
                    })
                });

                log('âœ… åŸºæœ¬ãƒãƒƒãƒ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ', 'success');
                updateStep('step2', 'âœ… ã‚¹ãƒ†ãƒƒãƒ—2: åŸºæœ¬ãƒãƒƒãƒ—åˆæœŸåŒ–æˆåŠŸ', true);

                // ã‚¹ãƒ†ãƒƒãƒ—3: åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆ
                log('ğŸ”„ åº§æ¨™å¤‰æ›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ', 'info');
                const projectedCoords = ol.proj.fromLonLat(testCoords);
                log(`å¤‰æ›çµæœ: [${projectedCoords[0].toFixed(2)}, ${projectedCoords[1].toFixed(2)}]`, 'success');
                updateStep('step3', 'âœ… ã‚¹ãƒ†ãƒƒãƒ—3: åº§æ¨™å¤‰æ›æˆåŠŸ', true);

                // ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ†ã‚¹ãƒˆ
                log('ğŸ—ºï¸ OpenStreetMapãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ†ã‚¹ãƒˆ', 'info');
                const osmLayer = new ol.layer.Tile({
                    source: new ol.source.OSM()
                });
                map.addLayer(osmLayer);
                log('âœ… OSMãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ æˆåŠŸ', 'success');
                updateStep('step4', 'âœ… ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆãƒ»è¿½åŠ æˆåŠŸ', true);

                // ã‚¹ãƒ†ãƒƒãƒ—5: åœ°å›³è¡¨ç¤ºç¢ºèª
                setTimeout(() => {
                    try {
                        const mapDiv = document.getElementById('map');
                        const mapSize = map.getSize();
                        log(`åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚º: [${mapSize[0]}, ${mapSize[1]}]`, 'info');
                        
                        // ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ ã§ãƒ†ã‚¹ãƒˆ
                        const marker = new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat(testCoords))
                        });
                        
                        marker.setStyle(new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 10,
                                fill: new ol.style.Fill({color: 'red'}),
                                stroke: new ol.style.Stroke({color: 'white', width: 2})
                            }),
                            text: new ol.style.Text({
                                text: 'TEST',
                                font: '14px Arial',
                                fill: new ol.style.Fill({color: 'black'}),
                                offsetY: -25
                            })
                        }));

                        const vectorLayer = new ol.layer.Vector({
                            source: new ol.source.Vector({
                                features: [marker]
                            })
                        });
                        
                        map.addLayer(vectorLayer);
                        log('âœ… ãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚«ãƒ¼è¿½åŠ æˆåŠŸ', 'success');
                        updateStep('step5', 'âœ… ã‚¹ãƒ†ãƒƒãƒ—5: åœ°å›³è¡¨ç¤ºãƒ»ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ æˆåŠŸ', true);

                        // æœ€çµ‚åˆ¤å®š
                        document.getElementById('overall-status').innerHTML = 'âœ… å…¨ã¦ã®è¨ºæ–­é …ç›®ãŒæˆåŠŸã—ã¾ã—ãŸã€‚åœ°å›³ã¯æ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚';
                        document.getElementById('overall-status').className = 'test-step step-success';

                        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
                        map.on('click', function(evt) {
                            const coordinate = ol.proj.toLonLat(evt.coordinate);
                            log(`ğŸ–±ï¸ åœ°å›³ã‚¯ãƒªãƒƒã‚¯: ç·¯åº¦=${coordinate[1].toFixed(6)}, çµŒåº¦=${coordinate[0].toFixed(6)}`, 'success');
                            alert(`ã‚¯ãƒªãƒƒã‚¯ä½ç½®: ${coordinate[1].toFixed(6)}, ${coordinate[0].toFixed(6)}`);
                        });

                        log('ğŸ‰ åœ°å›³è¡¨ç¤ºè¨ºæ–­å®Œäº† - å…¨ã¦æˆåŠŸ', 'success');

                    } catch (error) {
                        log(`âŒ ã‚¹ãƒ†ãƒƒãƒ—5 å¤±æ•—: ${error.message}`, 'error');
                        updateStep('step5', `âŒ ã‚¹ãƒ†ãƒƒãƒ—5: ${error.message}`, false);
                    }
                }, 2000);

            } catch (error) {
                log(`âŒ ãƒãƒƒãƒ—åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStep('step2', `âŒ ã‚¹ãƒ†ãƒƒãƒ—2: ${error.message}`, false);
                document.getElementById('overall-status').innerHTML = `âŒ è¨ºæ–­å¤±æ•—: ${error.message}`;
                document.getElementById('overall-status').className = 'test-step step-error';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è¨ºæ–­å®Ÿè¡Œ
        window.addEventListener('load', function() {
            log('ğŸ“„ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'info');
            setTimeout(runDiagnostics, 500);
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(event) {
            log(`âŒ JavaScript ã‚¨ãƒ©ãƒ¼: ${event.error.message}`, 'error');
            log(`ã‚¨ãƒ©ãƒ¼å ´æ‰€: ${event.filename}:${event.lineno}`, 'error');
        });

    </script>
</body>
</html>