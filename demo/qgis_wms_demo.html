<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QGIS WMS デモンストレーション</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c5aa0;
            text-align: center;
        }
        h2 {
            color: #4a4a4a;
            border-bottom: 2px solid #2c5aa0;
            padding-bottom: 5px;
        }
        .endpoint {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .endpoint h3 {
            margin-top: 0;
            color: #2c5aa0;
        }
        .url {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin: 5px 0;
        }
        .example {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .map-container {
            border: 2px solid #2c5aa0;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
        .image-preview {
            text-align: center;
            margin: 20px 0;
        }
        .image-preview img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .button {
            background-color: #2c5aa0;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        .button:hover {
            background-color: #1e3d72;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .parameter-table th,
        .parameter-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .parameter-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗺️ QGIS WMS配信デモンストレーション</h1>
        
        <p>このページでは、QGISの現在のマップビューをWMS（Web Map Service）として配信する機能のデモンストレーションを行います。</p>
        
        <div id="server-status" class="status">
            <strong>サーバー状態:</strong> <span id="status-text">確認中...</span>
        </div>

        <h2>🌐 利用可能なエンドポイント</h2>

        <!-- WMS GetCapabilities -->
        <div class="endpoint">
            <h3>1. WMS GetCapabilities</h3>
            <p>WMSサービスの機能と利用可能なレイヤー情報を取得します。</p>
            <div class="url">
                <a href="http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetCapabilities" target="_blank">
                    http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetCapabilities
                </a>
            </div>
            <button class="button" onclick="testCapabilities()">GetCapabilities テスト</button>
            <div id="capabilities-result"></div>
        </div>

        <!-- WMS GetMap -->
        <div class="endpoint">
            <h3>2. WMS GetMap</h3>
            <p>指定されたBBOX（境界ボックス）とサイズで地図画像を取得します。</p>
            
            <table class="parameter-table">
                <tr>
                    <th>パラメータ</th>
                    <th>説明</th>
                    <th>例</th>
                </tr>
                <tr>
                    <td>SERVICE</td>
                    <td>サービス名（WMS固定）</td>
                    <td>WMS</td>
                </tr>
                <tr>
                    <td>REQUEST</td>
                    <td>リクエスト種別</td>
                    <td>GetMap</td>
                </tr>
                <tr>
                    <td>BBOX</td>
                    <td>境界ボックス（minx,miny,maxx,maxy）</td>
                    <td>139.0,35.0,140.0,36.0</td>
                </tr>
                <tr>
                    <td>WIDTH</td>
                    <td>画像幅（ピクセル）</td>
                    <td>800</td>
                </tr>
                <tr>
                    <td>HEIGHT</td>
                    <td>画像高さ（ピクセル）</td>
                    <td>600</td>
                </tr>
                <tr>
                    <td>CRS</td>
                    <td>座標参照系</td>
                    <td>EPSG:4326</td>
                </tr>
                <tr>
                    <td>FORMAT</td>
                    <td>画像フォーマット</td>
                    <td>image/png</td>
                </tr>
            </table>

            <div class="example">
                <strong>東京周辺の例:</strong><br>
                <div class="url">
                    <a href="http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetMap&BBOX=139.5,35.5,139.9,35.9&WIDTH=400&HEIGHT=400&CRS=EPSG:4326&FORMAT=image/png" target="_blank">
                        http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetMap&BBOX=139.5,35.5,139.9,35.9&WIDTH=400&HEIGHT=400&CRS=EPSG:4326&FORMAT=image/png
                    </a>
                </div>
            </div>

            <div class="image-preview">
                <h4>地図画像プレビュー:</h4>
                <img id="wms-preview" src="http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetMap&BBOX=139.5,35.5,139.9,35.9&WIDTH=400&HEIGHT=400&CRS=EPSG:4326&FORMAT=image/png" 
                     alt="WMS地図画像" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuOCteODvOODkOODvOOBq+aOpee2muOBp+OBjeOBvuOBm+OCiTwvdGV4dD48L3N2Zz4='; this.alt='サーバーに接続できません';" />
            </div>

            <button class="button" onclick="refreshMapImage()">地図画像を更新</button>
        </div>

        <!-- WMS GetFeatureInfo -->
        <div class="endpoint">
            <h3>3. WMS GetFeatureInfo</h3>
            <p>指定された座標の地物情報を取得します。</p>
            <div class="url">
                <a href="http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetFeatureInfo&I=200&J=200&INFO_FORMAT=application/json" target="_blank">
                    http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetFeatureInfo&I=200&J=200&INFO_FORMAT=application/json
                </a>
            </div>
            <button class="button" onclick="testFeatureInfo()">GetFeatureInfo テスト</button>
            <div id="featureinfo-result"></div>
        </div>

        <!-- タイル配信 -->
        <div class="endpoint">
            <h3>4. タイル配信（Slippy Map Tiles）</h3>
            <p>OpenStreetMapスタイルのタイル配信APIです。ズームレベル、X座標、Y座標を指定します。</p>
            <div class="url">
                http://localhost:8089/tiles/{z}/{x}/{y}.png
            </div>
            <div class="example">
                <strong>例:</strong><br>
                <div class="url">
                    <a href="http://localhost:8089/tiles/10/904/403.png" target="_blank">
                        http://localhost:8089/tiles/10/904/403.png
                    </a>
                </div>
            </div>
            <div class="image-preview">
                <h4>タイル画像プレビュー（Z=10, X=904, Y=403）:</h4>
                <img id="tile-preview" src="http://localhost:8089/tiles/10/904/403.png" 
                     alt="タイル画像" width="256" height="256" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuOCv+OCpOODq+OBjOiqreOBv+i+vOOBvuOBvuOBm+OCiTwvdGV4dD48L3N2Zz4='; this.alt='タイルが読み込めません';" />
            </div>
        </div>

        <!-- 既存エンドポイント -->
        <div class="endpoint">
            <h3>5. 既存のエンドポイント</h3>
            <p>QMapPermalinkプラグインの既存機能も引き続き利用できます。</p>
            
            <h4>インタラクティブ地図:</h4>
            <div class="url">
                <a href="http://localhost:8089/qgis-map?lat=35.681&lon=139.767&scale=25000" target="_blank">
                    http://localhost:8089/qgis-map?lat=35.681&lon=139.767&scale=25000
                </a>
            </div>

            <h4>PNG画像直接配信:</h4>
            <div class="url">
                <a href="http://localhost:8089/qgis-png?lat=35.681&lon=139.767&scale=25000&width=800&height=600" target="_blank">
                    http://localhost:8089/qgis-png?lat=35.681&lon=139.767&scale=25000&width=800&height=600
                </a>
            </div>
        </div>

        <h2>🧭 OpenLayersを使用したWMS表示例</h2>
        <div class="map-container">
            <div id="map" style="width: 100%; height: 400px;"></div>
        </div>

        <h2>📋 使用方法</h2>
        <ol>
            <li><strong>QGISでプロジェクトを開く:</strong> 配信したい地図レイヤーをQGISで表示します。</li>
            <li><strong>QMapPermalinkプラグインを有効化:</strong> プラグインを起動してHTTPサーバーを開始します。</li>
            <li><strong>WMSクライアントで接続:</strong> 上記のエンドポイントURLを使ってWMSクライアント（QGIS、OpenLayers等）から接続します。</li>
            <li><strong>リアルタイム更新:</strong> QGISでマップビューを変更すると、WMS配信内容もリアルタイムで更新されます。</li>
        </ol>

        <h2>⚙️ 技術仕様</h2>
        <ul>
            <li><strong>WMSバージョン:</strong> 1.3.0</li>
            <li><strong>対応座標系:</strong> EPSG:4326 (WGS84), EPSG:3857 (Web Mercator)</li>
            <li><strong>対応フォーマット:</strong> image/png, image/jpeg</li>
            <li><strong>タイル仕様:</strong> XYZ Tiles (256x256ピクセル)</li>
            <li><strong>サーバーポート:</strong> 8089 (デフォルト)</li>
        </ul>
    </div>

    <!-- OpenLayers CSS と JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <script>
        // サーバー状態チェック
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetCapabilities');
                if (response.ok) {
                    document.getElementById('status-text').textContent = 'オンライン ✅';
                    document.getElementById('server-status').className = 'status success';
                } else {
                    throw new Error('Server responded with error');
                }
            } catch (error) {
                document.getElementById('status-text').textContent = 'オフライン ❌';
                document.getElementById('server-status').className = 'status error';
            }
        }

        // GetCapabilitiesテスト
        async function testCapabilities() {
            const resultDiv = document.getElementById('capabilities-result');
            resultDiv.innerHTML = '<p>GetCapabilities リクエスト送信中...</p>';
            
            try {
                const response = await fetch('http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetCapabilities');
                const text = await response.text();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>成功:</strong> GetCapabilities レスポンスを取得しました。
                        </div>
                        <details>
                            <summary>XMLレスポンス詳細</summary>
                            <pre style="background-color: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 12px;">${escapeHtml(text)}</pre>
                        </details>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        <strong>エラー:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // GetFeatureInfoテスト
        async function testFeatureInfo() {
            const resultDiv = document.getElementById('featureinfo-result');
            resultDiv.innerHTML = '<p>GetFeatureInfo リクエスト送信中...</p>';
            
            try {
                const response = await fetch('http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetFeatureInfo&I=200&J=200&INFO_FORMAT=application/json');
                const text = await response.text();
                
                if (response.ok) {
                    const data = JSON.parse(text);
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>成功:</strong> GetFeatureInfo レスポンスを取得しました。
                        </div>
                        <details>
                            <summary>JSONレスポンス詳細</summary>
                            <pre style="background-color: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        <strong>エラー:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // 地図画像を更新
        function refreshMapImage() {
            const img = document.getElementById('wms-preview');
            const timestamp = new Date().getTime();
            const baseUrl = 'http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetMap&BBOX=139.5,35.5,139.9,35.9&WIDTH=400&HEIGHT=400&CRS=EPSG:4326&FORMAT=image/png';
            img.src = `${baseUrl}&_t=${timestamp}`;
        }

        // HTMLエスケープ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // OpenLayersマップ初期化
        function initMap() {
            // WMSレイヤーを作成
            const wmsLayer = new ol.layer.Image({
                source: new ol.source.ImageWMS({
                    url: 'http://localhost:8089/wms',
                    params: {
                        'SERVICE': 'WMS',
                        'REQUEST': 'GetMap',
                        'LAYERS': 'QGIS_Map',
                        'FORMAT': 'image/png',
                        'CRS': 'EPSG:3857'
                    },
                    crossOrigin: 'anonymous'
                })
            });

            // ベースマップ（OpenStreetMap）
            const osmLayer = new ol.layer.Tile({
                source: new ol.source.OSM(),
                opacity: 0.5
            });

            // マップを作成
            const map = new ol.Map({
                target: 'map',
                layers: [osmLayer, wmsLayer],
                view: new ol.View({
                    center: ol.proj.fromLonLat([139.7, 35.7]), // 東京
                    zoom: 10
                })
            });

            // クリックイベント（GetFeatureInfo）
            map.on('singleclick', async function(evt) {
                const coordinate = evt.coordinate;
                const lonlat = ol.proj.toLonLat(coordinate);
                const pixel = map.getEventPixel(evt.originalEvent);
                
                try {
                    const response = await fetch(`http://localhost:8089/wms?SERVICE=WMS&REQUEST=GetFeatureInfo&I=${Math.round(pixel[0])}&J=${Math.round(pixel[1])}&INFO_FORMAT=application/json`);
                    const data = await response.json();
                    
                    alert(`地物情報:\n座標: ${lonlat[1].toFixed(6)}, ${lonlat[0].toFixed(6)}\nレイヤー数: ${data.layers.length}`);
                } catch (error) {
                    console.error('GetFeatureInfo error:', error);
                }
            });
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            checkServerStatus();
            initMap();
            
            // 30秒ごとにサーバー状態をチェック
            setInterval(checkServerStatus, 30000);
        });
    </script>
</body>
</html>